<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ” å¯†ç¢¼ç”¢ç”Ÿå™¨</title>
  <style>
    :root {
      --primary-color: #3b82f6;
      --primary-hover: #2563eb;
      --bg-color: #f3f4f6;
      --card-bg: #ffffff;
      --text-main: #1f2937;
      --text-sub: #6b7280;
      --border-color: #d1d5db;
      --result-bg: #f8fafc;
      --success-color: #10b981;
      --font-mono: 'SF Mono', 'Fira Code', 'Roboto Mono', Menlo, Consolas, monospace;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-color: #111827;
        --card-bg: #1f2937;
        --text-main: #f9fafb;
        --text-sub: #9ca3af;
        --border-color: #374151;
        --result-bg: #111827;
      }
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      transition: all 0.2s ease;
    }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background-color: var(--bg-color);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      color: var(--text-main);
      padding: 1rem;
    }

    .container {
      background-color: var(--card-bg);
      padding: 2rem;
      border-radius: 20px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 460px;
      border: 1px solid var(--border-color);
    }

    header h1 {
      text-align: center;
      margin-bottom: 1.5rem;
      font-size: 1.5rem;
      letter-spacing: -0.5px;
    }

    /* çµæœå€å¡Š */
    .result-wrapper {
      background-color: var(--result-bg);
      border: 2px solid var(--border-color);
      border-radius: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      margin-bottom: 0.5rem;
    }

    #result {
      word-break: break-all;
      font-family: var(--font-mono);
      font-size: 1.3rem;
      font-weight: 600;
      flex-grow: 1;
      margin-right: 10px;
    }

    .btn-copy {
      background-color: var(--primary-color);
      color: #ffffff;
      border: none;
      padding: 0.6rem 0;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 0.9rem;
      width: 60px;
      min-width: 60px;
    }

    .btn-copy:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-copy.copied {
      background-color: var(--success-color);
    }

    /* å¼·åº¦æ¢ */
    .strength-meter {
      height: 6px;
      width: 100%;
      background: #e5e7eb;
      border-radius: 3px;
      margin-top: 12px;
      overflow: hidden;
    }

    #strength-bar {
      height: 100%;
      width: 0%;
      transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      margin: 8px 0 25px 0;
      color: var(--text-sub);
      font-weight: 500;
    }

    /* è¨­å®šé¸å–® */
    .settings-group {
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    input[type="number"] {
      width: 65px;
      padding: 0.5rem;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--result-bg);
      color: var(--text-main);
      text-align: center;
      font-weight: bold;
    }

    /* --- ç´” CSS é–‹é—œæ¨£å¼ --- */
    .switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .3s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    input:checked+.slider {
      background-color: var(--primary-color);
    }

    input:checked+.slider:before {
      transform: translateX(20px);
    }

    /* ---------------------- */

    .btn-generate {
      background: transparent;
      color: #3b82f6;
      border: none;
      padding: 10px;
      margin-left: -10px;
      margin-right: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      outline: none;
    }

    .btn-generate:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-generate:focus-visible {
      outline: 2px solid var(--primary-color);
      outline-offset: 2px;
    }

    .btn-generate {
      background: transparent;
      color: #3b82f6;
      /* å¯ä»¥æ ¹æ“šä½ çš„ä¸»é¡Œä¿®æ”¹é¡è‰² */
      border: none;
      padding: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    /* é‡æ–°æ•´ç†åœ–ç¤ºä¸»é«” */
    .icon-refresh {
      width: 20px;
      height: 20px;
      border: 2px solid currentColor;
      border-right-color: transparent;
      /* ç•™å‡ºç¼ºå£åšç®­é ­ */
      border-radius: 50%;
      position: relative;
      transition: transform 0.4s ease-in-out;
      /* transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); */
    }

    /* ç¹ªè£½ç®­é ­å°–ç«¯ */
    .icon-refresh::before {
      content: "";
      position: absolute;
      top: -2px;
      right: -2px;
      border-top: 5px solid transparent;
      border-left: 8px solid currentColor;
      border-bottom: 5px solid transparent;
      transform: rotate(-45deg);
    }

    /* æ ¸å¿ƒæŠ€å·§ï¼šé»æ“Šæ™‚è§¸ç™¼æ—‹è½‰ä¸€åœˆ */
    /* ç•¶æŒ‰éˆ•è¢«é»æ“Š (active) æ™‚ï¼ŒåŸ·è¡Œ spin å‹•ç•« 0.5 ç§’ */
    /* .btn-generate:active>.icon-refresh {
      animation: spin-once 0.5s ease-in-out;
    } */

    /* æ‡¸åœç‹€æ…‹ï¼šè¼•å¾®æ—‹è½‰ */
    .btn-generate:hover:not([disabled]):not(.is-spinning)>.icon-refresh {
      transform: rotate(67.5deg);
    }

    /* é»æ“Šè§¸ç™¼çš„ä¸€åœˆå‹•ç•«ï¼šå„ªå…ˆæ¬Šæœ€é«˜ */
    /* ä½¿ç”¨ animation-fill-mode: forwards ç¢ºä¿çµæŸæ™‚ç‹€æ…‹ç©©å®š */
    .is-spinning>.icon-refresh {
      animation: spin-once 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes spin-once {
      0% {
        transform: rotate(inherit);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .btn-generate:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .btn-generate:focus-visible {
      outline: 2px solid currentColor;
      outline-offset: 4px;
      border-radius: 4px;
    }

    footer {
      margin-top: 1.5rem;
      text-align: center;
      font-size: 0.8rem;
      color: var(--text-sub);
      opacity: 0.8;
    }
  </style>
</head>

<body>

  <main class="container">
    <header>
      <h1>ğŸ” å¯†ç¢¼ç”¢ç”Ÿå™¨</h1>
    </header>

    <div class="result-wrapper">
      <button class="btn-generate" id="generate" title="é‡æ–°æ•´ç†">
        <span class="icon-refresh"></span>
      </button>
      <div id="result">è¼‰å…¥ä¸­...</div>
      <button class="btn-copy" id="clipboard">è¤‡è£½</button>
    </div>

    <div class="strength-meter">
      <div id="strength-bar"></div>
    </div>
    <div class="info-row">
      <span id="strength-text">å¼·åº¦ï¼š-</span>
      <span title="æœ¬ç†µå€¼ç‚ºç†è«–ä¼°ç®—ï¼šå‡è¨­æ¯å€‹å­—å…ƒç¨ç«‹ä¸”å‡å‹»éš¨æ©Ÿå–è‡ªæ‰€é¸å­—å…ƒæ± ã€‚éƒ¨åˆ†ç·šä¸Šå·¥å…·æœƒç”¨å­—å…¸/æ¨¡å¼çŒœæ¸¬æ¨¡å‹ï¼Œå› æ­¤æ•¸å€¼å¯èƒ½ä¸åŒã€‚">ç†µå€¼ä¼°ç®—ï¼š<span id="entropy-val">0
          bits</span></span>

    </div>

    <div class="settings-group">
      <div class="setting-item">
        <span>å¯†ç¢¼é•·åº¦ (5-128)</span>
        <input type="number" id="length" min="5" max="128" value="16" length="3">
      </div>

      <label class="setting-item">
        <span>åŒ…å«å¤§å¯« (A-Z)</span>
        <div class="switch">
          <input type="checkbox" id="uppercase" checked>
          <span class="slider"></span>
        </div>
      </label>

      <label class="setting-item">
        <span>åŒ…å«å°å¯« (a-z)</span>
        <div class="switch">
          <input type="checkbox" id="lowercase" checked>
          <span class="slider"></span>
        </div>
      </label>

      <label class="setting-item">
        <span>åŒ…å«æ•¸å­— (0-9)</span>
        <div class="switch">
          <input type="checkbox" id="numbers" checked>
          <span class="slider"></span>
        </div>
      </label>

      <label class="setting-item">
        <span>åŒ…å«ç¬¦è™Ÿ (!@#$)</span>
        <div class="switch">
          <input type="checkbox" id="symbols" checked>
          <span class="slider"></span>
        </div>
      </label>

      <label class="setting-item">
        <span>å¼·åˆ¶æ¶µè“‹å·²é¸é¡åˆ¥</span>
        <div class="switch">
          <input type="checkbox" id="force-at-least-one" checked>
          <span class="slider"></span>
        </div>
      </label>

      <label class="setting-item">
        <span>æ’é™¤æ˜“æ··æ·†å­—å…ƒ (l, 1, O, 0)</span>
        <div class="switch">
          <input type="checkbox" id="exclude-ambiguous">
          <span class="slider"></span>
        </div>
      </label>

      <label class="setting-item">
        <span>æ’é™¤ç¨‹å¼æ˜“è¡çªç¬¦è™Ÿ (' " ` \ /)</span>
        <div class="switch">
          <input type="checkbox" id="exclude-code-unsafe">
          <span class="slider"></span>
        </div>
      </label>
    </div>

    <footer>CSPRNG + Fisher-Yates | å®‰å…¨æœ¬åœ°é‹ç®—</footer>
  </main>

  <script>
    'use strict';

    const STORAGE_KEY = 'pwd_gen_v3_settings';
    const CHARS = {
      LOWER: 'abcdefghijklmnopqrstuvwxyz',
      UPPER: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ',
      NUMS: '0123456789',
      SYMBOLS: '!@#$%^&*()_+~`|}{[]:;?><,./-=',
      AMBIGUOUS: 'il1Lo0O',
      CODE_UNSAFE: '\'"`\\/<>[]{}()' // å®šç¾©å®¹æ˜“é€ æˆç¨‹å¼è§£æå•é¡Œçš„ç¬¦è™Ÿ
    };

    const els = {
      result: document.getElementById('result'),
      length: document.getElementById('length'),
      uppercase: document.getElementById('uppercase'),
      lowercase: document.getElementById('lowercase'),
      numbers: document.getElementById('numbers'),
      symbols: document.getElementById('symbols'),
      forceAtLeastOne: document.getElementById('force-at-least-one'),
      excludeAmbiguous: document.getElementById('exclude-ambiguous'),
      excludeCodeUnsafe: document.getElementById('exclude-code-unsafe'),
      generateBtn: document.getElementById('generate'),
      clipboardBtn: document.getElementById('clipboard'),
      bar: document.getElementById('strength-bar'),
      strText: document.getElementById('strength-text'),
      entropyText: document.getElementById('entropy-val')
    };

    // å®‰å…¨éš¨æ©Ÿèˆ‡æ´—ç‰Œæ¼”ç®—æ³•
    function getSecureRandomInt(max) {
      const RANGE = 0x100000000;

      if (!Number.isInteger(max) || max <= 0 || max > RANGE) {
        throw new RangeError(`max must be an integer in [1, ${RANGE}]`);
      }
      if (max === 1) return 0;

      const limit = Math.floor(RANGE / max) * max;
      const buf = new Uint32Array(1);
      let x;
      do { window.crypto.getRandomValues(buf); x = buf[0]; } while (x >= limit);
      return x % max;
    }

    function fisherYatesShuffleStr(str) {
      const array = [...str];
      return fisherYatesShuffle(array).join('');
    }

    function fisherYatesShuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = getSecureRandomInt(i + 1);
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    // è¨­å®šå­˜å–
    function saveSettings() {
      const s = {
        l: els.length.value,
        u: els.uppercase.checked,
        lo: els.lowercase.checked,
        n: els.numbers.checked,
        s: els.symbols.checked,
        f1: els.forceAtLeastOne.checked,
        ea: els.excludeAmbiguous.checked,
        ec: els.excludeCodeUnsafe.checked
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
    }

    function loadSettings() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (!saved) return;
      const s = JSON.parse(saved);
      els.length.value = s.l;
      els.uppercase.checked = s.u ?? true;
      els.lowercase.checked = s.lo ?? true;
      els.numbers.checked = s.n ?? true;
      els.symbols.checked = s.s ?? true;
      els.forceAtLeastOne.checked = s.f1 ?? true;
      els.excludeAmbiguous.checked = s.ea ?? false;
      els.excludeCodeUnsafe.checked = s.ec ?? false;
    }

    /**
      * BigInt ç²¾ç¢ºçµ„åˆè¨ˆæ•¸ (æ’å®¹åŸç†)
      * è¨ˆç®—åœ¨é•·åº¦ L ä¸‹ï¼Œæ»¿è¶³ã€Œè‡³å°‘åŒ…å«ä¸€å€‹å·²é¸é¡åˆ¥å­—å…ƒã€çš„æ‰€æœ‰å¯èƒ½çµ„åˆç¸½æ•¸ (T)
      * @param {number} len å¯†ç¢¼é•·åº¦ L
      * @param {number[]} setSizes å·²é¸å­—å…ƒé¡åˆ¥çš„å­—å…ƒæ•¸é™£åˆ— (ä¾‹å¦‚ [26,26,10,32])
      * @returns {BigInt} ç¸½çµ„åˆæ•¸ T
      */
    function countValidSequences(len, setSizes) {
      const k = setSizes.length;
      let totalValid = 0n;
      const L = BigInt(len);

      // æ’å®¹åŸç†ï¼šSum_{i=0}^{k} (-1)^i * Binomial(k, i) * (N - selected_i)^L
      // é€™è£¡ç°¡åŒ–è™•ç†ï¼šéæ­·æ‰€æœ‰é¡åˆ¥çš„å­é›†çµ„åˆ
      const totalMasks = 1 << k;
      for (let mask = 0; mask < totalMasks; mask++) {
        let currentPoolSize = 0n;
        let bitCount = 0;

        for (let i = 0; i < k; i++) {
          if (!(mask & (1 << i))) {
            currentPoolSize += BigInt(setSizes[i]);
          } else {
            bitCount++;
          }
        }

        const term = currentPoolSize ** L;
        if (bitCount % 2 === 0) {
          totalValid += term;
        } else {
          totalValid -= term;
        }
      }
      return totalValid;
    }

    /**
     * å°‡ BigInt è½‰æ›ç‚º Log2 (ç²¾ç¢ºè‡³å°æ•¸é»)
     * @param {BigInt} bigint
     * @returns {number} log2(bigint)
     */
    function bigIntLog2(bigint) {
      if (bigint <= 0n) return 0;
      const s = bigint.toString();

      // å¦‚æœå­—ä¸²é•·åº¦å°æ–¼ 15ï¼Œä»£è¡¨æ•¸å€¼åœ¨ JavaScript Number çš„å®‰å…¨ç²¾ç¢ºç¯„åœå…§ (2^53 - 1)
      // ç›´æ¥è½‰æ›æˆæ•¸å­—è¨ˆç®— log2 å³å¯ï¼Œé¿å…å¾ŒçºŒçš„ä½æ•¸è£œå„Ÿè¨ˆç®—
      if (s.length <= 15) {
        return Math.log2(Number(bigint));
      }

      // å°æ–¼æ¥µå¤§æ•¸å€¼ï¼Œå–å‰ 15 ä½æœ‰æ•ˆæ•¸å­—è¨ˆç®—ï¼Œå†åŠ ä¸Šä½æ•¸å·®ç•°ç”¢ç”Ÿçš„æ¬Šé‡
      const num = parseFloat(s.substring(0, 15));
      const log2 = Math.log2(num) + (s.length - 15) * Math.log2(10);
      return log2;
    }

    /**
     * å®‰å…¨è¦å¾‹æª¢æŸ¥ (Pattern Check)
     * æª¢æŸ¥æ˜¯å¦åŒ…å«éæ–¼ç°¡å–®çš„è¦å¾‹ï¼ˆå¦‚é€£çºŒéå¢/éæ¸›å­—å…ƒæˆ–é‡è¤‡å­—å…ƒï¼‰
     * @param {string} str å¯†ç¢¼å­—ä¸²
     */
    function isTooSimple(str) {
      if (str.length < 3) return false;
      for (let i = 0; i < str.length - 2; i++) {
        const a = str.charCodeAt(i);
        const b = str.charCodeAt(i + 1);
        const c = str.charCodeAt(i + 2);
        // æª¢æŸ¥éå¢ (abc, 123) æˆ– éæ¸› (cba, 321) æˆ– é‡è¤‡ (aaa)
        if ((b === a + 1 && c === b + 1) || (b === a - 1 && c === b - 1) || (a === b && b === c)) {
          return true;
        }
      }
      return false;
    }

    /**
     * æ›´æ–°å¼·åº¦ UI é¡¯ç¤º(åƒ…è² è²¬é¡¯ç¤º)
     * @param {number} entropy - å·²è¨ˆç®—å¥½çš„ç†µå€¼(bits)
     */
    function updateUI(entropy) {
      if (isNaN(entropy) || !isFinite(entropy) || entropy <= 0) {
        els.entropyText.textContent = `0.000 bits`;
        els.bar.style.width = '0%';
        els.strText.textContent = `å¼·åº¦ï¼š-`;
        els.strText.style.color = 'inherit';
        return;
      }

      // å¼·åˆ¶ä¿ç•™ä¸‰ä½å°æ•¸ï¼Œä¸è¶³å‰‡è£œ 0
      const formattedEntropy = entropy.toFixed(3);

      els.entropyText.textContent = `${formattedEntropy} bits`;

      let color = '#ef4444', width = '20%', label = 'å¼±';
      if (entropy >= 100) { color = '#10b981'; width = '100%'; label = 'é ‚ç´š'; }
      else if (entropy >= 80) { color = '#22c55e'; width = '80%'; label = 'æ¥µå¼·'; }
      else if (entropy >= 60) { color = '#eab308'; width = '60%'; label = 'è‰¯å¥½'; }
      else if (entropy >= 40) { color = '#f97316'; width = '40%'; label = 'æ™®é€š'; }

      els.bar.style.width = width;
      els.bar.style.backgroundColor = color;
      els.strText.textContent = `å¼·åº¦ï¼š${label}`;
      els.strText.style.color = color;
    }

    function ensureCrypto() {
      if (!window.crypto || !window.crypto.getRandomValues) {
        throw new Error('æ­¤ç’°å¢ƒä¸æ”¯æ´å®‰å…¨éš¨æ©Ÿæ•¸ï¼ˆéœ€è¦ HTTPS / ç¾ä»£ç€è¦½å™¨ï¼‰');
      }
    }

    function disabledUI(flag) {
      if (flag) {
        updateUI(0); // ç©ºå¯†ç¢¼,ç†µå€¼ç‚º 0

        // ã€Œå·²è¤‡è£½ã€ç‹€æ…‹æ™‚éœ€é‡ç½®
        if (els.clipboardBtn.classList.contains('copied')) {
          els.clipboardBtn.textContent = 'è¤‡è£½';
          els.clipboardBtn.classList.remove('copied');
        }

        els.clipboardBtn.disabled = true;
        els.generateBtn.disabled = true;
        return;
      } else {
        els.clipboardBtn.disabled = false;
        els.generateBtn.disabled = false;
      }
    }

    function checkActiveSets(len, config, forceEach) {
      const activeCount = config.filter(t => t.el.checked && t.set.length > 0).length;

      if (activeCount === 0) {
        throw new Error(`âš ï¸ è«‹é¸æ“‡é¡å‹`);
      }

      if (forceEach && len < activeCount) {
        throw new Error(`âš ï¸ é•·åº¦ä¸è¶³ï¼šè‡³å°‘è¦ ${activeCount}`);
      }
    }

    function generate() {
      // é‡è¨­è¤‡è£½æŒ‰éˆ•ç‹€æ…‹
      els.clipboardBtn.textContent = 'è¤‡è£½';
      els.clipboardBtn.classList.remove('copied');

      try {
        ensureCrypto();
      } catch (e) {
        els.result.textContent = `âš ï¸ ${e.message}`;
        disabledUI(true);
        return;
      }

      refreshEffect(els.generateBtn);

      const len = Math.max(5, Math.min(128, parseInt(els.length.value) || 5));

      let definitionChars = {
        Include: {
          lowercase: { el: els.lowercase, set: CHARS.LOWER },
          uppercase: { el: els.uppercase, set: CHARS.UPPER },
          numbers: { el: els.numbers, set: CHARS.NUMS },
          symbols: { el: els.symbols, set: CHARS.SYMBOLS }
        },
        Exclude: {
          ambiguous: { el: els.excludeAmbiguous, set: CHARS.AMBIGUOUS },
          codeUnsafe: { el: els.excludeCodeUnsafe, set: CHARS.CODE_UNSAFE }
        }
      };

      let exclude = definitionChars.Exclude;
      let include = definitionChars.Include;

      // åŸ·è¡Œæ’é™¤é‚è¼¯
      const checkAndExclude = (isExclude, fullSet, excludeSet) => isExclude
        ? [...fullSet].filter(c => !excludeSet.includes(c)).join('')
        : fullSet;
      include.lowercase.set = checkAndExclude(exclude.ambiguous.el.checked, include.lowercase.set, exclude.ambiguous.set);
      include.uppercase.set = checkAndExclude(exclude.ambiguous.el.checked, include.uppercase.set, exclude.ambiguous.set);
      include.numbers.set = checkAndExclude(exclude.ambiguous.el.checked, include.numbers.set, exclude.ambiguous.set);
      include.symbols.set = checkAndExclude(exclude.codeUnsafe.el.checked, include.symbols.set, exclude.codeUnsafe.set);

      const config = Object.values(include);

      const forceEach = (els.forceAtLeastOne?.checked ?? true);

      try {
        checkActiveSets(len, config, forceEach);
      } catch (e) {
        els.result.textContent = e.message;
        disabledUI(true);
        return;
      }

      // å»ºç«‹å®Œæ•´å­—å…ƒæ± èˆ‡å„é¡åˆ¥å­—å…ƒæ•¸é™£åˆ—
      const activeConfigs = config.filter(t => t.el.checked && t.set.length > 0);
      const activeSets = activeConfigs.map(t => t.set);
      let pool = activeSets.join('');

      let attempts = 0;
      let password = "";
      const maxAttempts = 1000; // é˜²æ­¢æ¥µç«¯æƒ…æ³æ­»å¾ªç’°

      while (attempts < maxAttempts) {
        attempts++;
        password = "";
        // ç´”ç²¹å–æ¨£ï¼šå¾ç¸½æ± ä¸­å‡å‹»æŠ½å–
        for (let i = 0; i < len; i++) {
          password += pool[getSecureRandomInt(pool.length)];
        }

        // å¼·åˆ¶é¡åˆ¥æ¶µè“‹ (Rejection)
        if (forceEach) {
          const isMissing = config.some(t => t.el.checked && ![...password].some(char => t.set.includes(char)));
          if (isMissing) continue;
        }

        // åŠ ä¸Š Fisher-Yates Shuffle ç¢ºä¿åˆ†ä½ˆçµ•å°å‡å‹»ï¼Œæ¶ˆé™¤éš±å½¢åèª¤ï¼Œå¢åŠ å®‰å…¨æ€§ç·©è¡
        password = fisherYatesShuffleStr(password);

        // æ’é™¤ç°¡å–®è¦å¾‹ (Rejection)
        // è€ƒæ…®å¾Œï¼Œç‚ºé¿å…å½±éŸ¿ç†µå€¼ï¼Œæ‰€ä»¥ç§»é™¤æ­¤æª¢æ ¸
        //if (isTooSimple(password)) continue;

        break; // é€šéæ‰€æœ‰æª¢æŸ¥
      }

      if (attempts >= maxAttempts) {
        els.result.textContent = `âš ï¸ ç”¢ç”Ÿå¤±æ•—ï¼Œè«‹èª¿æ•´è¨­å®šå¾Œé‡è©¦ã€‚`;
        disabledUI(true);
        return;
      }

      // æœ€çµ‚å¯†ç¢¼
      els.result.textContent = password;

      // è¨ˆç®—ç†µå€¼
      const setSizes = activeSets.map(s => s.length);
      let entropyRaw;
      if (!forceEach) {
        const totalAll = BigInt(pool.length) ** BigInt(len);  // ç²¾ç¢ºçš„ N^L
        entropyRaw = bigIntLog2(totalAll);                    // èˆ‡ ON ç›¸åŒçš„ log2 è¿‘ä¼¼æ–¹å¼
      } else {
        const totalValid = countValidSequences(len, setSizes);
        entropyRaw = bigIntLog2(totalValid);
      }
      const entropy = Math.round(entropyRaw * 1000) / 1000; // ç²¾ç¢ºåˆ°å°æ•¸é»å¾Œä¸‰ä½
      updateUI(entropy);

      disabledUI(false);
      saveSettings();
    }

    function refreshEffect(btn) {
      // å…ˆç§»é™¤ class (é‡ç½®å‹•ç•«)
      btn.classList.remove('is-spinning');

      // å¼·åˆ¶ç€è¦½å™¨é‡ç¹ª (Reflow) ç¢ºä¿å‹•ç•«å¯ä»¥é‡æ–°è§¸ç™¼
      void btn.offsetWidth;

      // åŠ ä¸Šæ—‹è½‰ class
      btn.classList.add('is-spinning');

      // ç›£è½å‹•ç•«çµæŸ
      btn.addEventListener('animationend', () => {
        // æª¢æŸ¥æ»‘é¼ ç›®å‰æ˜¯å¦ã€Œä¸åœ¨ã€æŒ‰éˆ•ä¸Šæ–¹
        if (!btn.matches(':hover')) {
          btn.classList.remove('is-spinning');
        } else {
          // å¦‚æœæ»‘é¼ é‚„åœ¨ä¸Šé¢ï¼Œç›£è½ä¸€æ¬¡æ€§çš„ mouseleave
          btn.addEventListener('mouseleave', () => {
            btn.classList.remove('is-spinning');
          }, { once: true });
        }
      }, { once: true });
    }

    // äº‹ä»¶ç¶å®š
    els.generateBtn.addEventListener('click', generate);

    els.clipboardBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(els.result.textContent);
        els.clipboardBtn.textContent = 'å·²è¤‡è£½';
        els.clipboardBtn.classList.add('copied');

        // 2 ç§’å¾Œæ¢å¾©åŸç‹€
        await new Promise((resolve) => setTimeout(resolve, 1800));
        els.clipboardBtn.textContent = 'è¤‡è£½';
        els.clipboardBtn.classList.remove('copied');
      } catch (e) { }
    });

    // ç›£è½æ‰€æœ‰è¼¸å…¥å¯¦ç¾å³æ™‚é‡ç®—
    [els.length, els.uppercase, els.lowercase, els.numbers, els.symbols, els.forceAtLeastOne, els.excludeAmbiguous, els.excludeCodeUnsafe].forEach(input => {
      input.addEventListener('input', generate);
    });

    // åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', () => {
      loadSettings();
      generate();
    });
  </script>
</body>

</html>